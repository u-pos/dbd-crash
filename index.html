<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>マッチ3ゲーム</title>
<style>
  body {
    background: #111;
    color: white;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    user-select: none;
    margin: 0;
    height: 100vh;
    overflow: hidden;
  }
  #game-container {
    display: grid;
    grid-template-columns: repeat(6, 60px);
    grid-template-rows: repeat(6, 60px);
    gap: 4px;
    margin-top: 20px;
    touch-action: none;
  }
  .cell {
    width: 60px;
    height: 60px;
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    transition: transform 0.25s ease-in-out;
  }
  .disappearing {
    animation: pop-out 0.3s forwards;
  }
  @keyframes pop-out {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0); opacity: 0; }
  }
  .falling {
    transition: transform 0.4s cubic-bezier(.34,1.56,.64,1);
  }
  #info {
    margin-top: 10px;
    font-size: 18px;
  }
  #start-btn {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px 40px;
    font-size: 24px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    z-index: 10;
  }
</style>
</head>
<body>

<h1>マッチ3ゲーム</h1>
<div id="info" style="display:none;">
  スコア: <span id="score">0</span> | 残り時間: <span id="time">60</span>秒
</div>
<div id="game-container"></div>

<button id="start-btn">スタート</button>

<audio id="swapSound" src="a.mp3"></audio>
<audio id="matchSound" src="b.mp3"></audio>
<audio id="startSound" src="c.mp3"></audio>

<script>
const rows = 6;
const cols = 6;
const images = ['tile1.png','tile2.png','tile3.png','tile4.png','tile5.png','tile6.png'];
let board = [];
let score = 0;
let timeLeft = 60;
let firstCell = null;
let lockBoard = false;
let timer = null;

const gameContainer = document.getElementById('game-container');
const scoreEl = document.getElementById('score');
const timeEl = document.getElementById('time');
const info = document.getElementById('info');
const startBtn = document.getElementById('start-btn');

const swapSound = document.getElementById('swapSound');
const matchSound = document.getElementById('matchSound');
const startSound = document.getElementById('startSound');

function initBoard() {
  board = [];
  gameContainer.innerHTML = '';
  for (let r = 0; r < rows; r++) {
    const row = [];
    for (let c = 0; c < cols; c++) {
      const type = Math.floor(Math.random() * images.length);
      row.push(type);
      const cell = document.createElement('div');
      cell.classList.add('cell');
      cell.style.backgroundImage = `url(${images[type]})`;
      cell.dataset.row = r;
      cell.dataset.col = c;
      gameContainer.appendChild(cell);
    }
    board.push(row);
  }
}

function startGame() {
  score = 0;
  timeLeft = 60;
  scoreEl.textContent = score;
  timeEl.textContent = timeLeft;
  initBoard();
  info.style.display = 'block';
  startBtn.style.display = 'none';
  startSound.play();

  if (timer) clearInterval(timer);
  timer = setInterval(() => {
    timeLeft--;
    timeEl.textContent = timeLeft;
    if (timeLeft <= 0) {
      clearInterval(timer);
      alert(`ゲーム終了！ スコア: ${score}`);
      startBtn.style.display = 'block';
    }
  }, 1000);
}

function swapCells(cell1, cell2) {
  const r1 = +cell1.dataset.row;
  const c1 = +cell1.dataset.col;
  const r2 = +cell2.dataset.row;
  const c2 = +cell2.dataset.col;
  [board[r1][c1], board[r2][c2]] = [board[r2][c2], board[r1][c1]];
  cell1.style.backgroundImage = `url(${images[board[r1][c1]]})`;
  cell2.style.backgroundImage = `url(${images[board[r2][c2]]})`;
}

function findMatches() {
  const matches = [];
  // 横
  for (let r = 0; r < rows; r++) {
    let matchLength = 1;
    for (let c = 1; c < cols; c++) {
      if (board[r][c] === board[r][c - 1] && board[r][c] !== null) {
        matchLength++;
      } else {
        if (matchLength >= 3) {
          for (let k = 0; k < matchLength; k++) {
            matches.push({ r, c: c - 1 - k });
          }
        }
        matchLength = 1;
      }
    }
    if (matchLength >= 3) {
      for (let k = 0; k < matchLength; k++) {
        matches.push({ r, c: cols - 1 - k });
      }
    }
  }
  // 縦
  for (let c = 0; c < cols; c++) {
    let matchLength = 1;
    for (let r = 1; r < rows; r++) {
      if (board[r][c] === board[r - 1][c] && board[r][c] !== null) {
        matchLength++;
      } else {
        if (matchLength >= 3) {
          for (let k = 0; k < matchLength; k++) {
            matches.push({ r: r - 1 - k, c });
          }
        }
        matchLength = 1;
      }
    }
    if (matchLength >= 3) {
      for (let k = 0; k < matchLength; k++) {
        matches.push({ r: rows - 1 - k, c });
      }
    }
  }
  return matches;
}

function removeMatches(matches) {
  matches.forEach(pos => {
    const cell = document.querySelector(`.cell[data-row="${pos.r}"][data-col="${pos.c}"]`);
    if (cell) cell.classList.add('disappearing');
    board[pos.r][pos.c] = null;
  });
  matchSound.play();
  score += matches.length * 10;
  scoreEl.textContent = score;
}

function dropTiles() {
  for (let c = 0; c < cols; c++) {
    for (let r = rows - 1; r >= 0; r--) {
      if (board[r][c] === null) {
        for (let nr = r - 1; nr >= 0; nr--) {
          if (board[nr][c] !== null) {
            board[r][c] = board[nr][c];
            board[nr][c] = null;
            const cell = document.querySelector(`.cell[data-row="${nr}"][data-col="${c}"]`);
            const targetCell = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
            targetCell.style.backgroundImage = cell.style.backgroundImage;
            cell.style.backgroundImage = '';
            break;
          }
        }
      }
    }
  }
  // 新しいタイル生成
  for (let c = 0; c < cols; c++) {
    for (let r = 0; r < rows; r++) {
      if (board[r][c] === null) {
        const type = Math.floor(Math.random() * images.length);
        board[r][c] = type;
        const cell = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
        cell.style.backgroundImage = `url(${images[type]})`;
        cell.classList.add('falling');
        setTimeout(() => cell.classList.remove('falling'), 400);
      }
    }
  }
}

let startX, startY;
gameContainer.addEventListener('touchstart', e => {
  if (e.target.classList.contains('cell')) {
    firstCell = e.target;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }
}, { passive: false });

gameContainer.addEventListener('touchmove', e => {
  e.preventDefault();
}, { passive: false });

gameContainer.addEventListener('touchend', e => {
  if (!firstCell) return;
  const endX = e.changedTouches[0].clientX;
  const endY = e.changedTouches[0].clientY;
  const diffX = endX - startX;
  const diffY = endY - startY;
  if (Math.abs(diffX) > Math.abs(diffY)) {
    if (diffX > 30) swapWithNeighbor(firstCell, 0, 1);
    else if (diffX < -30) swapWithNeighbor(firstCell, 0, -1);
  } else {
    if (diffY > 30) swapWithNeighbor(firstCell, 1, 0);
    else if (diffY < -30) swapWithNeighbor(firstCell, -1, 0);
  }
  firstCell = null;
});

function swapWithNeighbor(cell, dr, dc) {
  if (lockBoard) return;
  const r = +cell.dataset.row;
  const c = +cell.dataset.col;
  const nr = r + dr;
  const nc = c + dc;
  if (nr < 0 || nr >= rows || nc < 0 || nc >= cols) return;
  const neighbor = document.querySelector(`.cell[data-row="${nr}"][data-col="${nc}"]`);
  swapSound.play();
  swapCells(cell, neighbor);
  lockBoard = true;
  setTimeout(() => {
    const matches = findMatches();
    if (matches.length > 0) {
      removeMatches(matches);
      setTimeout(() => {
        dropTiles();
        setTimeout(() => {
          const chainMatches = findMatches();
          if (chainMatches.length > 0) {
            removeMatches(chainMatches);
            setTimeout(dropTiles, 300);
          }
          lockBoard = false;
        }, 300);
      }, 300);
    } else {
      swapCells(cell, neighbor);
      lockBoard = false;
    }
  }, 300);
}

startBtn.addEventListener('click', startGame);
</script>
</body>
</html>
