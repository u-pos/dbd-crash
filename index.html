<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>マッチ3ゲーム</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    background: #222;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    overflow: hidden;
    color: white;
    font-family: sans-serif;
}
#gameContainer {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100vw;
    height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
}
canvas {
    display: block;
    touch-action: none;
    background: #000;
}
.overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 1.5em;
    z-index: 10;
}
button {
    padding: 10px 20px;
    font-size: 1.2em;
    margin-top: 20px;
}
#scoreboard {
    display: flex;
    justify-content: space-between;
    width: 90%;
    margin-bottom: 5px;
}
#combo {
    font-size: 1.4em;
    font-weight: bold;
    color: yellow;
}
</style>
</head>
<body>

<div id="gameContainer">
    <div id="scoreboard">
        <div id="score">スコア: 0</div>
        <div id="time">残り60秒</div>
    </div>
    <canvas id="gameCanvas"></canvas>
</div>

<div id="overlay" class="overlay">
    <p>3つ以上繋げて消そう！<br>60秒で何点取れるかな？</p>
    <table border="1" cellpadding="5" style="color:white; border-collapse: collapse; margin-top:10px;">
        <tr><th>消去数</th><th>得点</th></tr>
        <tr><td>3個</td><td>100点</td></tr>
        <tr><td>4個</td><td>200点</td></tr>
        <tr><td>5個</td><td>300点</td></tr>
        <tr><th colspan="2">連鎖倍率</th></tr>
        <tr><td>2連鎖</td><td>2倍</td></tr>
        <tr><td>3連鎖</td><td>3倍</td></tr>
        <tr><td>…</td><td>…</td></tr>
        <tr><td>10連鎖</td><td>10倍</td></tr>
    </table>
    <button id="startBtn">START</button>
</div>

<script>
// ===== ゲーム設定 =====
const rows = 8;
const cols = 8;
const tileSize = 50;
let canvas, ctx;
let board = [];
let score = 0;
let timeLeft = 60;
let gameInterval, timerInterval;
let isAnimating = false;
let comboCount = 0;
let startTouch = null;
let vanishTiles = [];
let fallTiles = [];

const sounds = {
    start: new Audio('c.mp3'),
    match: new Audio('a.mp3'),
    bgm: new Audio('bgm.mp3')
};
sounds.bgm.loop = true;
sounds.bgm.volume = 0.2;

function initBoard() {
    board = [];
    for (let r = 0; r < rows; r++) {
        let row = [];
        for (let c = 0; c < cols; c++) {
            row.push(Math.floor(Math.random() * 5));
        }
        board.push(row);
    }
}

function drawBoard() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            let tile = board[r][c];
            if (tile !== null) {
                ctx.globalAlpha = 1;
                ctx.fillStyle = ['red','green','blue','yellow','purple'][tile];
                ctx.fillRect(c * tileSize, r * tileSize, tileSize-2, tileSize-2);
            }
        }
    }
}

function startGame() {
    document.getElementById('overlay').style.display = 'none';
    score = 0;
    timeLeft = 60;
    comboCount = 0;
    initBoard();
    sounds.start.play();
    sounds.bgm.play();
    drawBoard();
    timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('time').textContent = `残り${timeLeft}秒`;
        if (timeLeft <= 0) endGame();
    }, 1000);
}

function endGame() {
    clearInterval(timerInterval);
    sounds.bgm.pause();
    const overlay = document.getElementById('overlay');
    overlay.style.display = 'flex';
    overlay.innerHTML = `<div style="font-size:2em;">最終スコア: ${score}</div>
    <button onclick="location.reload()">もう一度</button>`;
}

document.getElementById('startBtn').addEventListener('click', startGame);

// ===== Canvas初期化 =====
canvas = document.getElementById('gameCanvas');
ctx = canvas.getContext('2d');
canvas.width = cols * tileSize;
canvas.height = rows * tileSize;

// ===== スワイプ検知 =====
canvas.addEventListener('touchstart', e => {
    startTouch = e.touches[0];
});
canvas.addEventListener('touchend', e => {
    if (!startTouch) return;
    const endTouch = e.changedTouches[0];
    const dx = endTouch.clientX - startTouch.clientX;
    const dy = endTouch.clientY - startTouch.clientY;
    if (Math.abs(dx) > Math.abs(dy)) {
        if (dx > 20) console.log('右スワイプ');
        else if (dx < -20) console.log('左スワイプ');
    } else {
        if (dy > 20) console.log('下スワイプ');
        else if (dy < -20) console.log('上スワイプ');
    }
    startTouch = null;
});

drawBoard();
</script>

</body>
</html>
