<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DBDクラッシュ！</title>
<style>
body {
  font-family: sans-serif;
  background: #f0f8ff;
  text-align: center;
}
#hud {
  display: flex;
  justify-content: space-around;
  font-size: 1.2em;
  margin-bottom: 0.5em;
}
#game {
  position: relative;
  width: 512px;
  height: 512px;
  margin: auto;
  display: grid;
  grid-template-columns: repeat(8, 64px);
  grid-template-rows: repeat(8, 64px);
  gap: 2px;
}
.tile {
  width: 64px;
  height: 64px;
  background-size: cover;
  position: relative;
  transition: transform 0.2s ease;
}
.falling {
  transition: transform 0.4s ease;
}
.clear {
  animation: vanish 0.4s ease forwards;
}
@keyframes vanish {
  0% { transform: scale(1); opacity: 1; }
  100% { transform: scale(0); opacity: 0; }
}
#startBtn {
  margin-top: 1em;
  padding: 0.5em 1em;
}
</style>
</head>
<body>

<h1>マッチ3タイムアタック</h1>
<div id="hud">
  <div>スコア: <span id="score">0</span></div>
  <div>残り: <span id="time">60</span>秒</div>
</div>
<div id="game"></div>
<button id="startBtn">スタート</button>

<script>
const ROWS = 8, COLS = 8, TYPES = 6;
const IMAGES = ['tile1.png','tile2.png','tile3.png','tile4.png','tile5.png','tile6.png'];

let board = [];
let score = 0;
let timeLeft = 60;
let timerId = null;
let lock = true; // ゲーム操作ロック

// 音声
const sndSwap = new Audio('a.mp3');
const sndClear = new Audio('b.mp3');
const sndStart = new Audio('c.mp3');

function randTile(){ return Math.floor(Math.random()*TYPES); }

function initBoard(){
  board = [];
  for(let r=0;r<ROWS;r++){
    board[r] = [];
    for(let c=0;c<COLS;c++){
      let t;
      do {
        t = randTile();
      } while(
        c>=2 && board[r][c-1]===t && board[r][c-2]===t ||
        r>=2 && board[r-1][c]===t && board[r-2][c]===t
      );
      board[r][c] = t;
    }
  }
}

function renderBoard(){
  const gameDiv = document.getElementById('game');
  gameDiv.innerHTML = '';
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const tile = document.createElement('div');
      tile.className = 'tile';
      tile.style.backgroundImage = `url(${IMAGES[board[r][c]]})`;
      tile.dataset.row = r;
      tile.dataset.col = c;
      gameDiv.appendChild(tile);
    }
  }
}

let startPos = null;
function handleTouchStart(e){
  if(lock) return;
  const target = e.target.closest('.tile');
  if(!target) return;
  startPos = {r:+target.dataset.row, c:+target.dataset.col, x:e.touches?e.touches[0].clientX:e.clientX, y:e.touches?e.touches[0].clientY:e.clientY};
}
function handleTouchEnd(e){
  if(lock || !startPos) return;
  const endX = e.changedTouches?e.changedTouches[0].clientX:e.clientX;
  const endY = e.changedTouches?e.changedTouches[0].clientY:e.clientY;
  const dx = endX - startPos.x;
  const dy = endY - startPos.y;
  let dir = null;
  if(Math.abs(dx) > Math.abs(dy)){
    if(dx > 20) dir = {dr:0, dc:1};
    else if(dx < -20) dir = {dr:0, dc:-1};
  } else {
    if(dy > 20) dir = {dr:1, dc:0};
    else if(dy < -20) dir = {dr:-1, dc:0};
  }
  if(dir){
    const nr = startPos.r + dir.dr;
    const nc = startPos.c + dir.dc;
    if(nr>=0 && nr<ROWS && nc>=0 && nc<COLS){
      swap({r:startPos.r,c:startPos.c}, {r:nr,c:nc});
    }
  }
  startPos = null;
}

function swap(a,b){
  [board[a.r][a.c], board[b.r][b.c]] = [board[b.r][b.c], board[a.r][a.c]];
  sndSwap.currentTime = 0; sndSwap.play();
  renderBoard();
  if(!checkMatches()){
    // 元に戻す
    [board[a.r][a.c], board[b.r][b.c]] = [board[b.r][b.c], board[a.r][a.c]];
    renderBoard();
  } else {
    processMatches(1);
  }
}

function checkMatches(){
  let matched = false;
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS-2;c++){
      const t = board[r][c];
      if(t>=0 && t===board[r][c+1] && t===board[r][c+2]) return true;
    }
  }
  for(let c=0;c<COLS;c++){
    for(let r=0;r<ROWS-2;r++){
      const t = board[r][c];
      if(t>=0 && t===board[r+1][c] && t===board[r+2][c]) return true;
    }
  }
  return false;
}

function processMatches(chain){
  let toClear = [];
  // 横
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS-2;c++){
      const t = board[r][c];
      if(t>=0 && t===board[r][c+1] && t===board[r][c+2]){
        let k=0;
        while(c+k<COLS && board[r][c+k]===t){
          toClear.push({r,c:c+k});
          k++;
        }
      }
    }
  }
  // 縦
  for(let c=0;c<COLS;c++){
    for(let r=0;r<ROWS-2;r++){
      const t = board[r][c];
      if(t>=0 && t===board[r+1][c] && t===board[r+2][c]){
        let k=0;
        while(r+k<ROWS && board[r+k][c]===t){
          toClear.push({r:r+k,c});
          k++;
        }
      }
    }
  }
  if(toClear.length>0){
    // スコア加算
    score += toClear.length * 100 * chain;
    document.getElementById('score').textContent = score;

    // 消すエフェクト
    toClear.forEach(p=>{
      const idx = p.r*COLS + p.c;
      const tile = document.querySelectorAll('.tile')[idx];
      tile.classList.add('clear');
    });
    sndClear.currentTime = 0; sndClear.play();

    setTimeout(()=>{
      toClear.forEach(p=>board[p.r][p.c] = -1);
      collapse(chain);
    }, 400);
  }
}

function collapse(chain){
  for(let c=0;c<COLS;c++){
    let pointer = ROWS-1;
    for(let r=ROWS-1;r>=0;r--){
      if(board[r][c] !== -1){
        board[pointer][c] = board[r][c];
        pointer--;
      }
    }
    for(let r=pointer;r>=0;r--){
      board[r][c] = randTile();
    }
  }
  renderBoard();
  if(checkMatches()){
    setTimeout(()=>processMatches(chain+1), 200);
  }
}

function startGame(){
  score = 0;
  timeLeft = 60;
  document.getElementById('score').textContent = score;
  document.getElementById('time').textContent = timeLeft;
  initBoard();
  renderBoard();
  lock = false;
  sndStart.currentTime = 0; sndStart.play();
  if(timerId) clearInterval(timerId);
  timerId = setInterval(()=>{
    timeLeft--;
    document.getElementById('time').textContent = timeLeft;
    if(timeLeft<=0){
      clearInterval(timerId);
      lock = true;
      alert(`終了！スコア: ${score}`);
    }
  },1000);
}

document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('game').addEventListener('mousedown', handleTouchStart);
document.getElementById('game').addEventListener('mouseup', handleTouchEnd);
document.getElementById('game').addEventListener('touchstart', handleTouchStart);
document.getElementById('game').addEventListener('touchend', handleTouchEnd);
</script>

</body>
</html>