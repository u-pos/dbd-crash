<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>Match-3 Mobile Swipe</title>
<style>
/* === Âü∫Êú¨„Çπ„Çø„Ç§„É´ === */
:root { --cols:8; --rows:8; --tile-size:11vw; }
html, body {
  margin:0; padding:0; width:100%; height:100%;
  overflow:hidden; overscroll-behavior:none;
  -webkit-touch-callout:none; -webkit-user-select:none; user-select:none;
  background:#111; color:#fff; font-family:sans-serif;
}
.wrap { width:100%; height:100%; display:flex; flex-direction:column; align-items:center; }
.ui { display:flex; flex-direction:column; align-items:center; }
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5vw; font-size:3.6vw; font-weight:600; }
.panel { background:rgba(255,255,255,0.04); padding:0.8vw 1.5vw; border-radius:12px; min-width:28vw; text-align:center; }
#combo { color:#ffde59; font-weight:900; font-size:4.4vw; }
.board { background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent); padding:6px; border-radius:10px; display:grid; grid-template-columns:repeat(var(--cols),var(--tile-size)); gap:4px; touch-action:none; box-sizing:border-box; }
.cell { width:var(--tile-size); height:var(--tile-size); border-radius:8px; overflow:hidden; background:#111a2a; display:flex;align-items:center;justify-content:center; }
.cell img { width:100%; height:100%; object-fit:cover; pointer-events:none; }
@keyframes vanish { 0%{transform:scale(1);opacity:1;} 50%{transform:scale(1.25);opacity:0.6;} 100%{transform:scale(0);opacity:0;} }
.vanish { animation:vanish 380ms cubic-bezier(.2,.9,.3,1) forwards; }
.drop { transition:transform 420ms cubic-bezier(.2,.8,.3,1); }
.start-overlay, #gameOverOverlay {
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.35); border-radius:10px; flex-direction:column; z-index:10;
}
.start-btn { background:linear-gradient(90deg,#ff7ab6,#7b61ff); border:none; padding:14px 26px; border-radius:999px; font-size:1.8rem; color:#fff; cursor:pointer;}
#gameOverOverlay { font-size:10vw; font-weight:900; color:#fff; flex-wrap:wrap; gap:1vw; text-align:center; line-height:1.1; }
.bottom-buttons { display:flex; justify-content:center; align-items:center; gap:1.5rem; margin-top:0.8rem; }
.icon-btn { background:none; border:none; font-size:2.8rem; color:white; cursor:pointer; line-height:1; }
.text-btn { background:none; border:2px solid #ffde59; border-radius:8px; padding:0.3rem 0.8rem; font-size:1.2rem; color:#ffde59; cursor:pointer; }
.pause-overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:black; z-index:20; flex-direction:column; color:white; font-size:1.5rem; }
.pause-overlay button { font-size:2.5rem; margin-top:1rem; }
</style>
</head>
<body>
<div class="wrap">
  <div class="ui">
    <div class="header">
      <div class="panel">Score: <span id="score">0</span></div>
      <div class="panel">ÊÆã„Çä <span id="time">60</span> Áßí</div>
      <div class="panel"><span id="combo"></span></div>
    </div>
    <div id="boardWrap" style="position:relative;">
      <div id="board" class="board"></div>
      <div id="overlay" class="start-overlay">
        <button id="startBtn" class="start-btn">START</button>
      </div>
      <div id="pauseOverlay" class="pause-overlay">
        <div id="pauseText">‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠</div>
        <button id="resumeBtn" class="start-btn">‚ñ∂ ÂÜçÈñã</button>
      </div>
      <div id="gameOverOverlay" style="display:none;"></div>
    </div>
    <div class="bottom-buttons">
      <button id="muteBtn" class="icon-btn">üîá</button>
      <button id="ruleBtn" class="text-btn">„É´„Éº„É´</button>
      <button id="pauseBtn" class="icon-btn">‚è∏</button>
    </div>
  </div>
</div>

<audio id="sndStart" src="s.mp3" preload="auto"></audio>
<audio id="sndClear" src="cc.mp3" preload="auto"></audio>
<audio id="bgm" src="bgm2.mp3" preload="auto" loop></audio>

<script>
const ROWS=8,COLS=8,TILE_TYPES=6,GAME_TIME=60;
let board=[],running=false,score=0,timeLeft=GAME_TIME,timerId,combo=1,processing=false;
const boardEl=document.getElementById('board');
const scoreEl=document.getElementById('score');
const timeEl=document.getElementById('time');
const comboEl=document.getElementById('combo');
const overlay=document.getElementById('overlay');
const gameOverOverlay=document.getElementById('gameOverOverlay');
const sndStart=document.getElementById('sndStart');
const sndClear=document.getElementById('sndClear');
const bgm=document.getElementById('bgm');
bgm.volume=0.2;

function idx(r,c){return r*COLS+c}
function rc(i){return [Math.floor(i/COLS),i%COLS]}
function randInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}
function generateBoard(){
  const b=new Array(ROWS*COLS).fill(0);
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      while(true){
        const t=randInt(1,TILE_TYPES);
        b[idx(r,c)]=t;
        let bad=false;
        if(c>=2 && b[idx(r,c-1)]===t && b[idx(r,c-2)]===t) bad=true;
        if(r>=2 && b[idx(r-1,c)]===t && b[idx(r-2,c)]===t) bad=true;
        if(!bad) break;
      }
    }
  }
  return b;
}
function findMatches(b){
  const clear=new Set();
  for(let r=0;r<ROWS;r++){
    let runT=null, runS=0, runL=0;
    for(let c=0;c<COLS;c++){
      const t=b[idx(r,c)];
      if(t===runT) runL++;
      else{
        if(runT && runL>=3){ for(let k=0;k<runL;k++) clear.add(idx(r,runS+k)); }
        runT=t; runS=c; runL=1;
      }
    }
    if(runT && runL>=3){ for(let k=0;k<runL;k++) clear.add(idx(r,runS+k)); }
  }
  for(let c=0;c<COLS;c++){
    let runT=null, runS=0, runL=0;
    for(let r=0;r<ROWS;r++){
      const t=b[idx(r,c)];
      if(t===runT) runL++;
      else{
        if(runT && runL>=3){ for(let k=0;k<runL;k++) clear.add(idx(runS+k,c)); }
        runT=t; runS=r; runL=1;
      }
    }
    if(runT && runL>=3){ for(let k=0;k<runL;k++) clear.add(idx(runS+k,c)); }
  }
  return Array.from(clear);
}
function collapseBoard(b){
  const nb=b.slice();
  for(let c=0;c<COLS;c++){
    const col=nb.filter((_,i)=>i%COLS===c && nb[i]!==0);
    const miss=ROWS-col.length;
    const newTiles=Array.from({length:miss},()=>randInt(1,TILE_TYPES));
    const newCol=newTiles.concat(col);
    for(let r=0;r<ROWS;r++) nb[idx(r,c)]=newCol[r];
  }
  return nb;
}
function swapTiles(b,i1,i2){ const nb=b.slice(); [nb[i1],nb[i2]]=[nb[i2],nb[i1]]; return nb; }
function scoreForMatch(c){ return c===3?100:c===4?200:c===5?300:0; }
function renderBoard(prevBoard){
  boardEl.innerHTML='';
  for(let i=0;i<board.length;i++){
    const cell=document.createElement('div');
    cell.className='cell'; cell.dataset.i=i;
    const t=board[i];
    if(t>0){
      const img=document.createElement('img');
      img.src=`tile${t}.png`;
      if(prevBoard && prevBoard[i]===0){
        img.style.transform='translateY(-120%)';
        img.classList.add('drop');
        requestAnimationFrame(()=>{ img.style.transform='translateY(0)'; });
      }
      cell.appendChild(img);
    }
    boardEl.appendChild(cell);
  }
}
function waitForAnimations(elements,timeout=600){
  return new Promise(res=>{
    if(!elements.length) return res();
    let rem=elements.length;
    elements.forEach(el=>{
      el.addEventListener('animationend', ()=>{
        if(--rem<=0) res();
      }, {once:true});
      setTimeout(()=>{ if(--rem<=0) res(); }, timeout);
    });
  });
}
function startGame(){
  bgm.currentTime=0; bgm.play().catch(()=>{});
  board=generateBoard(); score=0; timeLeft=GAME_TIME; combo=1; processing=false;
  running=true; overlay.style.display='none'; gameOverOverlay.style.display='none';
  updateUI(); renderBoard();
  sndStart.currentTime=0; sndStart.play();
  timerId=setInterval(()=>{
    timeLeft--; if(timeLeft<=0){ clearInterval(timerId); running=false; showGameOver(); }
    updateUI();
  },1000);
}
function updateUI(){
  scoreEl.textContent=score;
  timeEl.textContent=timeLeft;
  comboEl.textContent=combo>1?`${combo}„Ç≥„É≥„ÉúÔºÅ`:'';
}
function showGameOver(){
  bgm.pause();
  gameOverOverlay.style.display='flex';
  gameOverOverlay.innerHTML=`<div>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢</div><div style="font-size:15vw; font-weight:900;">${score}</div><button id="restartBtn" class="start-btn">RESTART</button>`;
  document.getElementById('restartBtn').addEventListener('click',()=>{startGame(); gameOverOverlay.style.display='none';});
}
function isAdjacent(i1,i2){ const [r1,c1]=rc(i1),[r2,c2]=rc(i2); return Math.abs(r1-r2)+Math.abs(c1-c2)===1; }
async function playerMove(i1,i2){
  if(!running||processing) return; if(!isAdjacent(i1,i2)) return;
  processing=true; let newB=swapTiles(board,i1,i2); let matches=findMatches(newB);
  if(!matches.length){ renderBoard(); processing=false; return; }
  board=newB; sndClear.play();
  let chain=0;
  while(true){
    matches=findMatches(board); if(!matches.length) break;
    chain++; sndClear.play();
    score += matches.length/3 * 100 * Math.min(chain,10);
    matches.forEach(i=>board[i]=0);
    await waitForAnimations([]);
    const prev=board.slice();
    board=collapseBoard(board); renderBoard(prev);
    await new Promise(r=>setTimeout(r,300));
  }
  updateUI(); processing=false;
}
let touchStartIndex=null, startX=0, startY=0;
boardEl.addEventListener('touchstart',e=>{
  if(!running||processing) return;
  const t=e.target.closest('.cell'); if(!t) return;
  touchStartIndex=Number(t.dataset.i); startX=e.touches[0].clientX; startY=e.touches[0].clientY;
},{passive:false});
boardEl.addEventListener('touchend',e=>{
  if(touchStartIndex===null||!running||processing) return;
  const dx=e.changedTouches[0].clientX-startX, dy=e.changedTouches[0].clientY-startY;
  if(Math.abs(dx)<20 && Math.abs(dy)<20) return;
  const [r,c]=rc(touchStartIndex); let tr=r, tc=c;
  if(Math.abs(dx)>Math.abs(dy)) tc+=(dx>0?1:-1); else tr+=(dy>0?1:-1);
  if(tr>=0&&tr<ROWS&&tc>=0&&tc<COLS) playerMove(touchStartIndex,idx(tr,tc));
  touchStartIndex=null;
},{passive:false});
function renderBoardInitial(){ board=generateBoard(); renderBoard(); }
renderBoardInitial(); updateUI();
document.getElementById('startBtn').addEventListener('click', startGame);

// === „Éü„É•„Éº„Éà ===
const muteBtn=document.getElementById('muteBtn');
let muted=false;
muteBtn.addEventListener('click',()=>{
  muted=!muted;
  bgm.muted=muted; sndClear.muted=muted; sndStart.muted=muted;
  muteBtn.textContent=muted?'üîà':'üîá';
});

// === ‰∏ÄÊôÇÂÅúÊ≠¢/„É´„Éº„É´ ===
const pauseOverlay=document.getElementById('pauseOverlay');
const resumeBtn=document.getElementById('resumeBtn');
function pauseGame(text){
  if(!running) return;
  clearInterval(timerId); running=false; bgm.pause();
  document.getElementById('pauseText').textContent = text;
  pauseOverlay.style.display='flex';
}
document.getElementById('pauseBtn').addEventListener('click',()=>pauseGame('‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠'));
document.getElementById('ruleBtn').addEventListener('click',()=>pauseGame('„É´„Éº„É´Ë™¨Êòé‰∏≠'));
resumeBtn.addEventListener('click',()=>{
  running=true; pauseOverlay.style.display='none';
  bgm.play().catch(()=>{});
  timerId=setInterval(()=>{ timeLeft--; if(timeLeft<=0){clearInterval(timerId); running=false; showGameOver();} updateUI(); },1000);
});

// Á∏¶„Çπ„ÇØ„É≠„Éº„É´Èò≤Ê≠¢
document.addEventListener('touchmove', e=>e.preventDefault(), {passive:false});
</script>
</body>
</html>
