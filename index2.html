<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>Match-3 Game with Ranking</title>
<style>
:root { --cols:8; --rows:8; --tile-size:11vw; }
html,body {margin:0;padding:0;width:100%;height:100%;background:#111;color:#fff;font-family:sans-serif;overflow:hidden;}
.wrap {display:flex;flex-direction:column;align-items:center;height:100%;}
.header {display:flex;justify-content:space-between;width:100%;padding:0.5rem;font-size:3.6vw;}
.panel {background:rgba(255,255,255,0.1);padding:0.5rem 0.8rem;border-radius:0.5rem;}
.board {display:grid;grid-template-columns:repeat(var(--cols),var(--tile-size));gap:4px;margin-top:0.5rem;}
.cell {background:#222;border-radius:0.5rem;overflow:hidden;display:flex;align-items:center;justify-content:center;}
.cell img {width:100%;height:100%;object-fit:cover;}
.start-overlay,#gameOverOverlay {position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,0.35);z-index:10;}
.start-btn {background:linear-gradient(90deg,#ff7ab6,#7b61ff);border:none;padding:10px 20px;border-radius:999px;font-size:1.8rem;color:#fff;cursor:pointer;}
.bottom-buttons {display:flex;gap:1rem;margin-top:0.5rem;}
.icon-btn {background:none;border:none;font-size:2rem;color:#fff;}
#rankingOverlay {position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;z-index:100;justify-content:center;align-items:center;}
.ranking-content {background:#fff;color:#000;padding:1rem;border-radius:8px;width:90%;max-width:500px;max-height:80%;overflow-y:auto;}
.congrats-message {
  color: #ffea00;
  font-size: 5vw;
  font-weight: bold;
  margin-bottom: 1rem;
  text-align: center;
  text-shadow: 0 0 8px #fff78a, 0 0 16px #ffcc00;
  animation: pulseGlow 1.5s ease-in-out infinite;
}
@keyframes pulseGlow {
  0%,100% { text-shadow: 0 0 8px #fff78a, 0 0 16px #ffcc00; transform: scale(1);}
  50% { text-shadow: 0 0 16px #fff78a, 0 0 32px #ffea00; transform: scale(1.05);}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="panel">Score: <span id="score">0</span></div>
    <div class="panel">残り <span id="time">60</span> 秒</div>
    <div class="panel"><span id="combo"></span></div>
  </div>
  <div style="position:relative;">
    <div id="board" class="board"></div>
    <div id="overlay" class="start-overlay"><button id="startBtn" class="start-btn">START</button></div>
    <div id="gameOverOverlay" style="display:none;" class="start-overlay"></div>
  </div>
  <div class="bottom-buttons">
    <button id="muteBtn" class="icon-btn">🔇</button>
    <button id="pauseBtn" class="icon-btn">⏸</button>
    <button id="rankingBtn" class="icon-btn">🏆</button>
  </div>
</div>

<div id="rankingOverlay">
  <div class="ranking-content">
    <button id="closeRanking" class="icon-btn" style="align-self:flex-end;">✖</button>
    <h2 style="text-align:center;">🏆 ランキング TOP20 🏆</h2>
    <div id="rankingList" style="font-size:4vw;"></div>
  </div>
</div>

<audio id="sndStart" src="s.mp3" preload="auto"></audio>
<audio id="sndClear" src="cc.mp3" preload="auto"></audio>
<audio id="bgm" src="bgm2.mp3" preload="auto" loop></audio>
<audio id="sndCong" src="cong.mp3" preload="auto"></audio>

<script>
const API_BASE_URL = 'https://junkhin.com/api/';
const ROWS=8, COLS=8, TILE_TYPES=6, GAME_TIME=60;
let board=[],running=false,score=0,timeLeft=GAME_TIME,timerId,combo=1,processing=false;
const boardEl=document.getElementById('board');
const scoreEl=document.getElementById('score');
const timeEl=document.getElementById('time');
const comboEl=document.getElementById('combo');
const overlay=document.getElementById('overlay');
const gameOverOverlay=document.getElementById('gameOverOverlay');
const sndStart=document.getElementById('sndStart');
const sndClear=document.getElementById('sndClear');
const bgm=document.getElementById('bgm');

function idx(r,c){return r*COLS+c;}
function rc(i){return [Math.floor(i/COLS),i%COLS];}
function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function generateBoard(){
  const b=new Array(ROWS*COLS).fill(0);
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      while(true){
        const t=randInt(1,TILE_TYPES);
        b[idx(r,c)]=t;
        if(c>=2 && b[idx(r,c-1)]==t && b[idx(r,c-2)]==t) continue;
        if(r>=2 && b[idx(r-1,c)]==t && b[idx(r-2,c)]==t) continue;
        break;
      }
    }
  }
  return b;
}
function findMatches(b){
  const clear=new Set();
  for(let r=0;r<ROWS;r++){
    let runT=null, runS=0;
    for(let c=0;c<COLS;c++){
      const t=b[idx(r,c)];
      if(t===runT){}else{if(runT && c-runS>=3)for(let k=0;k<c-runS;k++)clear.add(idx(r,runS+k));runT=t;runS=c;}
    }
    if(runT && COLS-runS>=3)for(let k=0;k<COLS-runS;k++)clear.add(idx(r,runS+k));
  }
  for(let c=0;c<COLS;c++){
    let runT=null, runS=0;
    for(let r=0;r<ROWS;r++){
      const t=b[idx(r,c)];
      if(t===runT){}else{if(runT && r-runS>=3)for(let k=0;k<r-runS;k++)clear.add(idx(runS+k,c));runT=t;runS=r;}
    }
    if(runT && ROWS-runS>=3)for(let k=0;k<ROWS-runS;k++)clear.add(idx(runS+k,c));
  }
  return Array.from(clear);
}
function collapseBoard(b){
  const nb=b.slice();
  for(let c=0;c<COLS;c++){
    let empty=ROWS-1;
    for(let r=ROWS-1;r>=0;r--){
      if(nb[idx(r,c)]!==0){
        nb[idx(empty,c)]=nb[idx(r,c)];
        if(empty!==r) nb[idx(r,c)]=0;
        empty--;
      }
    }
    for(let r=empty;r>=0;r--) nb[idx(r,c)]=randInt(1,TILE_TYPES);
  }
  return nb;
}
function renderBoard(){
  boardEl.innerHTML='';
  for(let i=0;i<board.length;i++){
    const t=board[i]; const cell=document.createElement('div'); cell.className='cell';
    if(t>0){const img=document.createElement('img'); img.src=`tile${t}.png`; cell.appendChild(img);}
    boardEl.appendChild(cell);
  }
}
function startGame(){
  overlay.style.display='none';
  gameOverOverlay.style.display='none';
  running=true; board=generateBoard(); score=0; timeLeft=GAME_TIME; combo=1; processing=false;
  updateUI(); renderBoard(); bgm.currentTime=0; bgm.play().catch(()=>{}); sndStart.play();
  clearInterval(timerId);
  timerId=setInterval(()=>{timeLeft--;if(timeLeft<=0){clearInterval(timerId);running=false;showGameOver();}updateUI();},1000);
}
function updateUI(){scoreEl.textContent=score; timeEl.textContent=timeLeft; comboEl.textContent=combo>1?`${combo}コンボ!`:'';}
function loadRanking(){
  fetch(API_BASE_URL+'get_scores.php').then(r=>r.json()).then(d=>{
    if(d.success){document.getElementById('rankingList').innerHTML='<ol>'+d.scores.map(s=>`<li>${s.name} - ${s.score}</li>`).join('')+'</ol>';}
    else{document.getElementById('rankingList').textContent='取得失敗';}
  }).catch(()=>{document.getElementById('rankingList').textContent='通信エラー';});
}
function showGameOver(){
  bgm.pause();
  fetch(API_BASE_URL+'check_rank.php',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({score})})
  .then(r=>r.json()).then(d=>{
    if(d.success && d.entersTop20){
      const cong=document.getElementById('sndCong'); if(cong){cong.currentTime=0; cong.play().catch(()=>{});}
      gameOverOverlay.style.display='flex';
      gameOverOverlay.innerHTML=`
        <div class="congrats-message">🎉 おめでとう！TOP20にランクインしました！ 🎉</div>
        <div>最終スコア</div>
        <div style="font-size:15vw;font-weight:900;">${score}</div>
        <input type="text" id="playerName" maxlength="50" placeholder="名前を入力" style="font-size:5vw;padding:8px;margin:1rem 0;border-radius:8px;">
        <div>
          <button id="saveNameBtn" class="start-btn">登録</button>
          <button id="retryBtn" class="start-btn" style="display:none;background:linear-gradient(90deg,#7bff8f,#2ecc71);">再挑戦</button>
        </div>`;
      const saveBtn=document.getElementById('saveNameBtn');
      const retryBtn=document.getElementById('retryBtn');
      const nameInput=document.getElementById('playerName');
      saveBtn.onclick=()=>{
        const name=nameInput.value.trim(); if(!name){alert('名前を入力');return;}
        fetch(API_BASE_URL+'save_score.php',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({name,score})})
        .then(r=>r.json()).then(res=>{
          if(res.success){alert('登録しました！'); loadRanking(); nameInput.style.display='none'; saveBtn.style.display='none'; retryBtn.style.display='inline-block';}
          else{alert(res.error||'登録失敗');}
        });
      };
      retryBtn.onclick=()=>{gameOverOverlay.style.display='none'; startGame();};
    } else {
      gameOverOverlay.style.display='flex';
      gameOverOverlay.innerHTML=`<div>最終スコア</div><div style="font-size:15vw;font-weight:900;">${score}</div><button id="restartBtn" class="start-btn">RESTART</button>`;
      document.getElementById('restartBtn').onclick=()=>{startGame(); gameOverOverlay.style.display='none';};
    }
  });
}

// 操作イベント
document.getElementById('startBtn').onclick=startGame;
document.getElementById('rankingBtn').onclick=()=>{loadRanking();document.getElementById('rankingOverlay').style.display='flex';};
document.getElementById('closeRanking').onclick=()=>{document.getElementById('rankingOverlay').style.display='none';};
document.getElementById('muteBtn').onclick=()=>{const m=bgm.muted=!bgm.muted;sndStart.muted=m;sndClear.muted=m;document.getElementById('muteBtn').textContent=m?'🔈':'🔇';};
renderBoard(); updateUI();
</script>
</body>
</html>
