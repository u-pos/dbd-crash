<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>Match-3 Mobile Swipe</title>
<style>
:root { --cols:8; --rows:8; --tile-size:11vw; }
html,body {
  margin:0; padding:0; width:100%; height:100%;
  overflow:hidden; overscroll-behavior:none;
  background:#111; color:#fff; font-family:sans-serif;
}
.wrap { width:100%; height:100%; display:flex; flex-direction:column; align-items:center; }
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5vw; font-size:3.6vw; font-weight:600; }
.panel { background:rgba(255,255,255,0.04); padding:0.8vw 1.5vw; border-radius:12px; min-width:28vw; text-align:center; }
#combo {color:#ffde59;font-weight:900;font-size:3.5vw;}
.board {background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent);padding:6px;border-radius:10px;
display:grid;grid-template-columns:repeat(var(--cols),var(--tile-size));gap:4px;touch-action:none;box-sizing:border-box;}
.cell {width:var(--tile-size);height:var(--tile-size);border-radius:8px;overflow:hidden;background:#111a2a;
display:flex;align-items:center;justify-content:center;}
.cell img {width:100%;height:100%;object-fit:cover;pointer-events:none;}
@keyframes vanish {0%{transform:scale(1);opacity:1;}50%{transform:scale(1.25);opacity:0.6;}100%{transform:scale(0);opacity:0;}}
.vanish {animation:vanish 180ms cubic-bezier(.2,.9,.3,1) forwards;}
.start-overlay,#gameOverOverlay {
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.35);border-radius:10px;flex-direction:column;z-index:10;
}
.start-btn {background:linear-gradient(90deg,#ff7ab6,#7b61ff);border:none;
padding:14px 26px;border-radius:999px;font-size:1.8rem;color:#fff;cursor:pointer;}
#gameOverOverlay {font-size:10vw;font-weight:900;flex-wrap:wrap;gap:1vw;text-align:center;}
.bottom-buttons {display:flex;justify-content:center;align-items:center;gap:1.5rem;margin-top:0.8rem;}
.icon-btn {background:none;border:none;font-size:2.8rem;color:white;cursor:pointer;}
.rules-table-fixed {margin-top:0.5rem;font-size:0.75rem;width:100%;}
.rules-table-fixed table {width:100%;color:#fff;border-collapse:collapse;text-align:center;}
.rules-table-fixed th,.rules-table-fixed td {border-bottom:1px solid #555;padding:0.2rem;}
.rules-table-fixed th {border-bottom:2px solid #ffde59;}
.pause-overlay {position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:black;z-index:20;
flex-direction:column;color:white;font-size:1.5rem;}
/* ランキングオーバーレイ */
#rankingOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 100;
  display: none;
  justify-content: center;
  align-items: center;
}
.ranking-content {
  background: rgba(255,255,255,0.95);
  color: #000;
  padding: 1rem;
  border-radius: 8px;
  width: 80%;
  max-width: 500px;
  display: flex;
  flex-direction: column;
  max-height: 80%;
  overflow-y: auto;
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="panel">Score: <span id="score">0</span></div>
    <div class="panel">残り <span id="time">60</span> 秒</div>
    <div class="panel"><span id="combo"></span></div>
  </div>
  <div id="boardWrap" style="position:relative;">
    <div id="board" class="board"></div>
    <div id="overlay" class="start-overlay">
      <button id="startBtn" class="start-btn">START</button>
    </div>
    <div id="pauseOverlay" class="pause-overlay">
      <div id="pauseText">一時停止中</div>
      <button id="resumeBtn" class="start-btn">▶</button>
    </div>
    <div id="gameOverOverlay" style="display:none;"></div>
  </div>
  <div class="bottom-buttons">
    <button id="muteBtn" class="icon-btn">🔇</button>
    <button id="pauseBtn" class="icon-btn">⏸</button>
    <button id="rankingBtn" class="icon-btn">🏆</button>
  </div>
  <div class="rules-table-fixed">
    <table>
      <thead><tr><th>得点ルール</th><th>内容</th></tr></thead>
      <tbody>
        <tr><td>3個消し</td><td>100点</td></tr>
        <tr><td>4個消し</td><td>300点</td></tr>
        <tr><td>5個消し</td><td>500点</td></tr>
        <tr>
          <td colspan="2">2コンボ目は得点2倍、3コンボ目は得点3倍。</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ランキングオーバーレイ -->
<div id="rankingOverlay">
  <div class="ranking-content">
    <button id="closeRanking" class="icon-btn" style="font-size:2rem;align-self:flex-end;">✖</button>
    <h2 style="text-align:center;">🏆 ランキング TOP20 🏆</h2>
    <div id="rankingList" style="font-size:4vw;"></div>
  </div>
</div>

<audio id="sndStart" src="s.mp3" preload="auto"></audio>
<audio id="sndClear" src="cc.mp3" preload="auto"></audio>
<audio id="bgm" src="bgm2.mp3" preload="auto" loop></audio>

<script>
/* 略：あなたの元のゲームロジック関数（generateBoard、findMatches等）は変更せず */

function escapeHtml(str){
  return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// ランキング読込
function loadRanking(){
  fetch('https://YOUR_DOMAIN/api/get_scores.php')
    .then(r=>r.json())
    .then(data=>{
      if(data.success){
        let html = '<ol>';
        data.scores.forEach(s => {
          html += `<li>${escapeHtml(s.name)} - ${s.score}</li>`;
        });
        html += '</ol>';
        document.getElementById('rankingList').innerHTML = html;
      }else{
        document.getElementById('rankingList').innerHTML = '<p>取得失敗</p>';
      }
    }).catch(err=>{
      console.error(err);
      document.getElementById('rankingList').innerHTML = '<p>通信エラー</p>';
    });
}

// ランキングボタンイベント
document.getElementById('rankingBtn').addEventListener('click',()=>{
  loadRanking();
  document.getElementById('rankingOverlay').style.display='flex';
});
document.getElementById('closeRanking').addEventListener('click',()=>{
  document.getElementById('rankingOverlay').style.display='none';
});

// showGameOver差し替え
function showGameOver(){
  bgm.pause();
  fetch('https://YOUR_DOMAIN/api/check_rank.php',{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams({score})
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.success && data.entersTop20){
      gameOverOverlay.style.display='flex';
      gameOverOverlay.innerHTML=`
        <div>最終スコア</div>
        <div style="font-size:15vw; font-weight:900;">${score}</div>
        <input type="text" id="playerName" maxlength="50" placeholder="名前を入力" style="font-size:5vw;padding:5px;margin:1rem 0;">
        <button id="saveNameBtn" class="start-btn">登録</button>
      `;
      document.getElementById('saveNameBtn').onclick=()=>{
        const name=document.getElementById('playerName').value.trim();
        if(!name){alert('名前を入力してください');return;}
        fetch('https://YOUR_DOMAIN/api/save_score.php',{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body:new URLSearchParams({name,score})
        })
        .then(r=>r.json())
        .then(res=>{
          if(res.success){
            alert('登録しました！');
            loadRanking();
            startGame();
          }else{
            alert(res.error || '登録失敗');
          }
        });
      };
    }else{
      gameOverOverlay.style.display='flex';
      gameOverOverlay.innerHTML=`
        <div>最終スコア</div>
        <div style="font-size:15vw; font-weight:900;">${score}</div>
        <button id="restartBtn" class="start-btn">RESTART</button>
      `;
      document.getElementById('restartBtn').onclick=()=>{
        startGame(); gameOverOverlay.style.display='none';
      };
    }
  });
}
</script>
</body>
</html>
