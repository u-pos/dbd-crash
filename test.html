<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Match-3 Game</title>
<style>
body {
    margin: 0;
    background: #222;
    color: white;
    text-align: center;
    font-family: sans-serif;
    overflow: hidden;
}
#overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 100;
}
#game {
    display: grid;
    margin: auto;
    touch-action: none;
}
.tile {
    width: 48px;
    height: 48px;
    background-size: cover;
    transition: transform 0.25s ease, top 0.25s ease;
}
@keyframes vanish {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.5; }
    100% { transform: scale(0); opacity: 0; }
}
.tile.vanish {
    animation: vanish 0.4s ease-out forwards;
}
#scoreboard {
    display: flex;
    justify-content: space-around;
    margin-top: 5px;
}
#rules {
    margin-top: 10px;
}
#rules table {
    border-collapse: collapse;
    margin: auto;
}
#rules th, #rules td {
    border: 1px solid white;
    padding: 4px 8px;
}
</style>
</head>
<body>
<div id="overlay">
    <p>3つ以上繋げて消そう！<br>60秒で何点取れるかな？</p>
    <button id="startBtn">START</button>
    <div id="rules">
        <table>
            <tr><th>消去数</th><th>得点</th></tr>
            <tr><td>3個</td><td>100点</td></tr>
            <tr><td>4個</td><td>200点</td></tr>
            <tr><td>5個</td><td>300点</td></tr>
            <tr><th>連鎖数</th><th>倍率</th></tr>
            <tr><td>2連鎖目</td><td>2倍</td></tr>
            <tr><td>3連鎖目</td><td>3倍</td></tr>
            <tr><td>…</td><td>…</td></tr>
            <tr><td>10連鎖目</td><td>10倍</td></tr>
        </table>
    </div>
</div>
<div id="scoreboard">
    <div id="score">スコア: 0</div>
    <div id="combo"></div>
    <div id="time">残り60秒</div>
</div>
<div id="game"></div>

<script>
const rows = 8;
const cols = 8;
const tileTypes = 6;
let board = [];
let score = 0;
let comboCount = 0;
let timeLeft = 60;
let gameInterval;

const gameEl = document.getElementById("game");
gameEl.style.gridTemplateColumns = `repeat(${cols}, 48px)`;
gameEl.style.gridTemplateRows = `repeat(${rows}, 48px)`;

function createBoard() {
    board = [];
    for (let r = 0; r < rows; r++) {
        board[r] = [];
        for (let c = 0; c < cols; c++) {
            let tile;
            do {
                tile = Math.floor(Math.random() * tileTypes) + 1;
            } while (wouldMatch(r, c, tile));
            board[r][c] = tile;
        }
    }
}

function wouldMatch(r, c, tile) {
    if (c >= 2 && board[r][c-1] === tile && board[r][c-2] === tile) return true;
    if (r >= 2 && board[r-1][c] === tile && board[r-2][c] === tile) return true;
    return false;
}

function drawBoard() {
    gameEl.innerHTML = "";
    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            const tileEl = document.createElement("div");
            tileEl.className = "tile";
            tileEl.style.backgroundImage = `url(tile${board[r][c]}.png)`;
            tileEl.dataset.row = r;
            tileEl.dataset.col = c;
            gameEl.appendChild(tileEl);
        }
    }
}

function findMatches() {
    let matches = [];
    // 横方向
    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols-2; c++) {
            let t = board[r][c];
            if (t && t === board[r][c+1] && t === board[r][c+2]) {
                matches.push([r,c],[r,c+1],[r,c+2]);
            }
        }
    }
    // 縦方向
    for (let c = 0; c < cols; c++) {
        for (let r = 0; r < rows-2; r++) {
            let t = board[r][c];
            if (t && t === board[r+1][c] && t === board[r+2][c]) {
                matches.push([r,c],[r+1,c],[r+2,c]);
            }
        }
    }
    return matches.filter((m, i, arr) =>
        arr.findIndex(x => x[0] === m[0] && x[1] === m[1]) === i
    );
}

function clearMatches(matches) {
    if (matches.length === 0) return false;
    comboCount++;
    let baseScore = 0;
    let tilesCount = matches.length;
    if (tilesCount >= 5) baseScore = 300;
    else if (tilesCount === 4) baseScore = 200;
    else baseScore = 100;
    score += baseScore * Math.min(comboCount, 10);
    document.getElementById("score").textContent = `スコア: ${score}`;
    document.getElementById("combo").textContent = `${comboCount}コンボ！`;

    matches.forEach(([r,c]) => {
        const tileEl = document.querySelector(`.tile[data-row='${r}'][data-col='${c}']`);
        if (tileEl) tileEl.classList.add("vanish");
        board[r][c] = null;
    });
    setTimeout(dropTiles, 300);
    return true;
}

function dropTiles() {
    for (let c = 0; c < cols; c++) {
        let empty = 0;
        for (let r = rows - 1; r >= 0; r--) {
            if (board[r][c] === null) {
                empty++;
            } else if (empty > 0) {
                board[r+empty][c] = board[r][c];
                board[r][c] = null;
            }
        }
        for (let r = 0; r < empty; r++) {
            board[r][c] = Math.floor(Math.random() * tileTypes) + 1;
        }
    }
    drawBoard();
    setTimeout(() => {
        let newMatches = findMatches();
        if (newMatches.length > 0) {
            clearMatches(newMatches);
        } else {
            comboCount = 0;
        }
    }, 250);
}

document.getElementById("startBtn").addEventListener("click", () => {
    document.getElementById("overlay").style.display = "none";
    score = 0;
    comboCount = 0;
    timeLeft = 60;
    createBoard();
    drawBoard();
    document.getElementById("score").textContent = `スコア: ${score}`;
    document.getElementById("combo").textContent = ``;
    document.getElementById("time").textContent = `残り${timeLeft}秒`;
    clearInterval(gameInterval);
    gameInterval = setInterval(() => {
        timeLeft--;
        document.getElementById("time").textContent = `残り${timeLeft}秒`;
        if (timeLeft <= 0) {
            clearInterval(gameInterval);
            alert(`ゲーム終了！\n最終スコア: ${score}`);
        }
    }, 1000);
});
</script>
</body>
</html>
